!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.TuaStorage={})}(this,function(e){"use strict";var t,a="请输入参数 key 或 fullKey!",h="syncFn 请返回 Promise!",y=30,d="TUA_STORAGE_PREFIX: ",m=function(e){return function(){return!e.apply(void 0,arguments)}},r=function(e,t,r){var n=r.value;return r.value=function(e){var t=this;return Array.isArray(e)?Promise.all(e.map(function(e){return n.call(t,e)})):n.call(this,e)},r},n=function(e,t,r){var o=r.value;return r.value=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t="string"==typeof e?{key:e}:e,r=t.key,n=void 0===r?"":r,i=t.fullKey;return""===n&&""===(void 0===i?"":i)?Promise.reject(a):o.call(this,e)},r},p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}();function l(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function s(r,n,e,t,i){var o={};return Object.keys(t).forEach(function(e){o[e]=t[e]}),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=e.slice().reverse().reduce(function(e,t){return t(r,n,e)||e},o),i&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(i):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(r,n,o),o=null),o}var u="There is NO valid storageEngine specified!\nPlease use:\n* wx (for miniprogram),\n* localStorage (for web),\n* AsyncStorage (for React Native)\nas the storageEngine...\nOtherwise data would be saved in cache(Memory) and lost after reload...";console.log("Tua-Storage Version: 1.3.0");var c=(s((t=function(){function v(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.syncFnMap,r=void 0===t?{}:t,n=e.whiteList,i=void 0===n?[]:n,o=e.storageEngine,a=void 0===o?null:o,s=e.defaultExpires,u=void 0===s?y:s,c=e.storageKeyPrefix,l=void 0===c?d:c;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,v),this.SE=a,this.taskList=[],this.whiteList=i,this.syncFnMap=r,this.defaultExpires=u,this.neverExpireMark=null,this.storageKeyPrefix=l;var f=function(){return Promise.resolve()};this.SEMap=this._getFormatedSE()||{_clear:f,_setItem:f,_getItem:f,_getAllKeys:function(){return Promise.resolve([])},_removeItem:f},this._cache=Object.create(null),this.clear([this.storageKeyPrefix]),this._clearExpiredData()}return o(v,[{key:"save",value:function(e){var t=e.key,r=void 0===t?"":t,n=e.data,i=e.expires,o=void 0===i?this.defaultExpires:i,a=e.fullKey,s=void 0===a?"":a,u=e.syncParams,c=void 0===u?{}:u,l=e.isEnableCache,f=void 0===l||l,v=this._isNeverExpired(o),y=v?this.neverExpireMark:parseInt(Date.now()/1e3)+o,h=s||this._getQueryKeyStr({prefix:r,syncParams:c}),d={rawData:n,expires:y};return!v&&o<=0?Promise.resolve():(f&&(this._cache[h]=d),this.SEMap._setItem(h,d))}},{key:"load",value:function(e){var t=e.key,r=void 0===t?"":t,n=e.syncFn,i=void 0===n?this.syncFnMap[r]:n,o=e.expires,a=void 0===o?this.defaultExpires:o,s=e.fullKey,u=void 0===s?"":s,c=e.syncParams,l=void 0===c?{}:c,f=e.isAutoSave,v=void 0===f||f,y=e.isEnableCache,h=void 0===y||y,d=u||this._getQueryKeyStr({prefix:r,syncParams:l});return this._findData({key:d,syncFn:i,expires:a,syncParams:l,isAutoSave:v,isEnableCache:h})}},{key:"remove",value:function(e){var t=("object"===(void 0===e?"undefined":i(e))?e.fullKey:"")||this.storageKeyPrefix+e;return delete this._cache[t],this.SEMap._removeItem(t)}},{key:"clear",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return this._clearFromCache(e),this.SEMap._clear(e)}},{key:"_isDataExpired",value:function(e){var t=e.expires,r=void 0===t?this.neverExpireMark:t;return!this._isNeverExpired(r)&&+r<parseInt(Date.now()/1e3)}},{key:"_isNeverExpired",value:function(e){return e===this.neverExpireMark}},{key:"_clearFromCache",value:function(e){var t=this;this._getKeysByWhiteList(e)(Object.keys(this._cache)).forEach(function(e){delete t._cache[e]})}},{key:"_clearExpiredData",value:function(){var r=this,e=this.SEMap,n=e._getItem,t=e._getAllKeys,i=e._removeItem;return t().then(function(e){return e.map(function(t){return n(t).then(function(e){return JSON.parse(e)}).then(r._isDataExpired.bind(r)).then(function(e){return e?i(t):Promise.resolve()}).catch(console.error)})}).then(Promise.all.bind(Promise))}},{key:"_getQueryKeyStr",value:function(e){var t=e.prefix,r=e.syncParams;return this.storageKeyPrefix+(0===Object.keys(r).length?t:t+"?"+function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(t).map(function(e){return e+"="+encodeURIComponent(t[e])}).join("&")}(r))}},{key:"_getKeysByWhiteList",value:function(e){var r=[].concat(l(e),l(this.whiteList));return function(e){return e.filter(function(t){return r.every(function(e){return!t.includes(e)})})}}},{key:"_getFormatedSE",value:function(){var t=this;if(!this.SE)return console.warn(u),null;var e={wx:["setStorage","getStorage","removeStorage","getStorageInfo"],ls:["getItem","setItem","removeItem"],as:["getItem","setItem","multiRemove"]},r=function(e){return!!t.SE[e]};if(e.wx.every(r))return this._formatMethodsByWX();var n=e.ls.filter(m(r)),i=e.as.filter(m(r)),o=e.wx.filter(m(r));if(n.length&&i.length&&o.length){var a=function(e){return console.warn("Missing required apis:\n* "+e.join("\n* "))};n.length&&a(n),i.length&&a(i),o.length&&a(o),console.warn(u)}try{var s=this.SE.setItem("test","test");return this.SE.removeItem("test"),!(!s||!s.then)?this._formatMethodsByAS():this._formatMethodsByLS()}catch(e){return null}}},{key:"_formatMethodsByWX",value:function(){var i=this,e=this.SE,t=e.setStorage,r=e.getStorage,n=e.removeStorage,o=e.getStorageInfo,a=function(n){return function(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return new Promise(function(e,t){return n.call(i.SE,p({fail:t,success:e},r))})}},s=a(n),u=a(t),c=a(r),l=a(o),f=function(e){return s({key:e})},v=function(){return l().then(function(e){return e.keys})};return{_clear:function(e){return v().then(i._getKeysByWhiteList(e)).then(function(e){return e.map(f)}).then(Promise.all.bind(Promise))},_setItem:function(e,t){return u({key:e,data:t})},_getItem:function(e){return c({key:e}).then(function(e){return e.data})},_getAllKeys:v,_removeItem:f}}},{key:"_formatMethodsByAS",value:function(){var t=this,e=this.SE,r=e.setItem,n=e.getItem,i=e.removeItem,o=e.getAllKeys,a=e.multiRemove,s=function(e){return e.bind(t.SE)},u=s(r),c=s(n),l=s(i),f=s(o),v=s(a);return{_clear:function(e){return f().then(t._getKeysByWhiteList(e)).then(v).catch(console.error)},_setItem:u,_getItem:c,_getAllKeys:f,_removeItem:l}}},{key:"_formatMethodsByLS",value:function(){var a=this,e=this.SE,t=e.setItem,r=e.getItem,n=e.removeItem,i=function(n){return function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return Promise.resolve(n.apply(a.SE,t))}},o=i(t),s=i(r),u=i(n),c=function(){for(var e=a.SE,t=e.key,r=[],n=0,i=e.length;n<i;n++){var o=t.call(a.SE,n);r.push(o)}return Promise.resolve(r)};return{_clear:function(e){var r=[].concat(l(e),l(a.whiteList)),t=function(t){return r.every(function(e){return!t.includes(e)})};return c().then(function(e){return e.filter(t)}).then(function(e){return e.map(function(e){return u(e)})}).then(Promise.all.bind(Promise)).catch(console.error)},_setItem:function(e,t){return o(e,JSON.stringify(t))},_getItem:s,_getAllKeys:c,_removeItem:u}}},{key:"_findData",value:function(e){var t=this,r=e.key,n=e.isEnableCache,i=function(e,t){var r={};for(var n in e)0<=t.indexOf(n)||Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r}(e,["key","isEnableCache"]),o=this._cache[r];return n&&o?this._loadData(p({key:r,cacheData:o},i)):this.SEMap._getItem(r).then(function(e){return t._loadData(p({key:r,cacheData:e},i))}).catch(function(){return t._loadData(p({key:r},i))})}},{key:"_loadData",value:function(e){var o=this,a=e.key,s=e.syncFn,u=e.expires,t=e.cacheData,c=e.syncParams,l=e.isAutoSave,r="string"==typeof t,n=function(){var e=function(e){return e.key===a},t=o.taskList.find(e),n=function(){o.taskList=o.taskList.filter(m(e))};if(t)return t.task;var r=s(c);if(!!(!r||!r.then))return Promise.reject(h);var i=r.then(function(e){return null==e.code&&null==e.data?{data:e}:e}).then(function(e){var t=e.code;return{code:+(void 0===t?0:t),data:e.data}}).then(function(e){var t=e.code,r=e.data;return n(),0===t&&l&&o.save({key:a.replace(o.storageKeyPrefix,""),data:{code:t,data:r},expires:u}).catch(console.warn),{code:t,data:r}}).catch(n);return o.taskList.push({key:a,task:i}),i},i=function(){return Promise.reject(new Error(JSON.stringify({key:a,syncFn:s})))};if(null==t)return s?n():i();var f=t=r?JSON.parse(t):t,v=f.expires,y=f.rawData;return this._isDataExpired({expires:v})?s?n():i():Promise.resolve(y)}}]),v}()).prototype,"save",[r,n],Object.getOwnPropertyDescriptor(t.prototype,"save"),t.prototype),s(t.prototype,"load",[r,n],Object.getOwnPropertyDescriptor(t.prototype,"load"),t.prototype),s(t.prototype,"remove",[r,n],Object.getOwnPropertyDescriptor(t.prototype,"remove"),t.prototype),t);e.default=c,Object.defineProperty(e,"__esModule",{value:!0})});
